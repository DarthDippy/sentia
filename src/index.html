<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>

<!--
    ===========
    GLOBAL META
    ===========
-->

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!--
    ==================
    PAGE-SPECIFIC META
    ==================
-->

    <title>Sentia - Enlightenment for your Environment</title>
    <meta name="description" content="Netflix Edda Visualization">

<!--
    ======
    STYLES
    ======
    The number of stylesheets here must be kept to a minimum.
    Unless adding a significant amount of CSS that is specific to a single page
    or section of the site, all new styles should be added to src/static/css/app.less.
-->

<!--[if lt IE 9]>      <link rel="stylesheet" href="/static/css/main.ie.min.css"> <![endif]-->
<!--[if gt IE 8]><!--> <link rel="stylesheet" href="/static/css/main.min.css"> <!--<![endif]-->

<!--
    ============
    HEAD SCRIPTS
    ============
    The following scripts must be included in the head. DO NOT ADD ANY MORE.
    All other scripts should go before the closing body tag.
    If you come across a script that makes a convincing case to be included in
    the head, then file an issue or PR to discuss including it.
-->

<!--[if lt IE 9]>
    <script src="/static/vendor/html5shiv/html5shiv-printshiv.min.js"></script>
<![endif]-->

    <script>
        // Confirm availability of JS and remove no-js class from html
        var docElement = document.documentElement;
        docElement.className = docElement.className.replace(/(^|\s)no-js(\s|$)/, '$1$2');
    </script>

</head>

<body>

<!--
    =================
    Begin page source
    =================
-->

<header class="wrapper wrapper__match-content" role="banner">
    <div class="block block__sub">
        <h1 id="pageHeader" class="superheader">Sentia</h1>
        <h6 id="pageSubHeader">Enlightenment for your Environment</h6>
    </div>
</header>

<main class="content" id="main" role="main">
    <div class="content_bar"></div>
    <div class="content_wrapper">
        <div class="content_main">
            <div class="expandable expandable__padded">
                <a class="expandable_target expandable_header"
                   href="#expandable-padded-content">
                    <span class="expandable_label expandable_header-left">
                        Filter
                    </span>
                    <span class="expandable_link expandable_header-right">
                        <span class="expandable_cue-open">
                            Show
                            <span class="cf-icon cf-icon-plus-round"></span>
                        </span>
                        <span class="expandable_cue-close">
                            Hide
                            <span class="cf-icon cf-icon-minus-round"></span>
                        </span>
                    </span>
                </a>
                <div class="expandable_content" id="expandable-padded-content">
                    <!-- Expandable Content Here -->
                    <p>EDDA FILTERS TBD, including slider.</p>
                </div>
            </div>
            <div id="nodeDiagram"></div>
            <div id="nodeDetails">
                <div class="detail-content">
                    <h6 id="detailName"></h6>Here is some content.<br>And some more content...
                </div>
            </div>

        </div><!-- END .content_main -->
    </div>
</main>

<footer role="contentinfo" class="content_main">
    <hr />
        <div class="">
            <p>Brought to you by the Technology &amp; Innovation Team. 
               <a href="http://team.cfpb.local/wiki/index.php/About_cfpb.local">About the cfpb.local.</a></p>
            <p>Content on the intranet is CFPB records and preserved in accordance with Federal laws. These records are subject to legal discovery and disclosure pursuant to the Freedom of Information Act. Personal information published on the intranet is covered by the <a href="http://team.cfpb.local/wiki/index.php/Intranet_Privacy_Act">Privacy Act Statement</a>.</p>
            <p>Actions on the intranet should be in accordance with the <a href="http://team.cfpb.local/aup">CFPB Policies</a>.</p>
        </div>
</footer>

<!--
    ============
    BODY SCRIPTS
    ============
    The number of scripts here must be kept to a minimum.
    Unless adding a significant amount of JS that is specific to a single page
    or section of the site, all custom JS should be added to src/static/js/app.js.
-->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/local/localVars.js"></script>
<script src="/static/js/main.min.js"></script>
<script>

var eddaData;

function createEndpoint(params){
    if(typeof params.collection === 'undefined' || typeof params.subject === 'undefined' || typeof params.query === 'undefined'){
        return console.log("Error - insufficient query parameters");
    }
    return serverURL + '/edda/api/v2/' + params.collection + '/' + params.subject + '/' + params.query;
}

function getData(endpoint, params){
    var request = $.ajax({
        dataType: 'jsonp',
        jsonpCallback: 'eddaResponse',
        url: endpoint,
        success: console.log('Edda get successful!')
    });
    request.fail( function( status ){
        console.log( 'no data was available at' + endpoint + '. status: ' + status );
    });
    request.done(function( status ){
        console.log( "Done!" );
    });
    request.complete( function( status ){
        console.log( "Complete" );
    });        
}

function eddaResponse(data){
    eddaData = data;
    return true;
}



function buildPage( dataFunctions ){
    // When a filter is applied, requery everything and redraw the diagram
    $.when( dataFunctions ).done(function( results ){
        console.log("results: ", results);
    });
}

/* 
    UTILITY FUNCTIONS  
*/

function getCircleSize(instType){
    switch( instType ){
        case '':
            return 300;
            break;
        case '':
            return 200;
            break;        
        default:
            return 100;
    }
}

function drawDiagram( eddaJson ){
    // Example borrowed from Mike Bostock's Awesome Zoomable Circle Packing: http://bl.ocks.org/mbostock/7607535
    var margin = 20,
        diameter = 650;
        // diameter = window.innerHeight ||
        //          html.clientHeight  ||
        //          body.clientHeight  ||
        //          screen.availHeight;

    var color = d3.scale.linear()
        .domain([-1, 5])
        .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
        .interpolate(d3.interpolateHcl);

    var pack = d3.layout.pack()
        .padding(2)
        .size([diameter - margin, diameter - margin])
        .value(function(d) { return 500; })

    var svg = d3.select("#nodeDiagram").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
      .append("g")
        .attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

      var root = { name: "eddaJson", children: eddaJson }; //create the root data object
      var focus = root,
          nodes = pack.nodes(root),
          view;

      var circle = svg.selectAll("circle")
        .data(nodes)
        .enter().append("circle")
          .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
          .style("fill", function(d) { return d.children ? color(d.depth) : null; })
          .on("click", function(d) { if (focus !== d) zoom(d), d3.event.stopPropagation(); });

      var text = svg.selectAll("text")
          .data(nodes)
        .enter().append("text")
          .attr("class", "label")
          .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
          .style("display", function(d) { return d.parent === root ? null : "none"; })
          .text(function(d) { return d.instanceId; });

      var node = svg.selectAll("circle.node,text")

      var nodeLeaf = svg.selectAll(".node--leaf,text")
        .on("mouseover", function(d){ $("#detailName").html("InstanceID: " + d.instanceId + "<br>Image ID: " + d.imageId); });


      d3.select("svg")
          .style("background", color(-1))
          .on("click", function() { zoom(root); });

      zoomTo([root.x, root.y, root.r * 2 + margin]);

      function zoom(d) {
        var focus0 = focus; focus = d;

        var transition = d3.transition()
            .duration(d3.event.altKey ? 7500 : 750)
            .tween("zoom", function(d) {
              var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
              return function(t) { zoomTo(i(t)); };
            });

        transition.selectAll("text")
          .filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
            .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
            .each("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
            .each("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
      }

      function zoomTo(v) {
        var k = diameter / v[2]; view = v;
        node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
        circle.attr("r", function(d) { return d.r * k; });
      }

    d3.select(self.frameElement).style("height", diameter + "px");

    /* TODO:
        - Remove node--leaf from selector for zoom potential
        - Find some colors that work better for AWS instances - assign classes for subnets once you get API access
        - Include Underscore / lodash in the dependencies so we can actually navigate the nodes
        - Take a look at possible navigation / slicing options that redraw based on selection
    */
}

$(function(){
    // drawDiagram();
})


</script>


</body>
